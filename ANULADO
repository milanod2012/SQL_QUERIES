USE [16022024]
GO
/****** Object:  Trigger [dbo].[TRIG_ANULADO]    Script Date: 26/07/2024 9:18:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER TRIGGER [dbo].[TRIG_ANULADO] ON [dbo].[SAACXC] 
FOR  UPDATE
AS
IF UPDATE (nroctrol)
BEGIN
IF (select nroctrol from inserted)='ANULADO'
BEGIN
IF (SELECT TIPOCXC FROM INSERTED)='31' 
BEGIN
update saacxc set monto=0, montoneto=0, mtotax=0, reteniva=0,saldo=0, saldoorg=0,
baseimpo=0
WHERE SAACXC.NroCtrol='ANULADO' AND SAACXC.NUMEROD=(SELECT NUMEROD FROM INSERTED)
UPDATE SAFACT SET  MONTO=0, MTOTAX=0,
TGRAVABLE=0, RETENIVA=0, MTOCOMIVTA=0, MTOCOMICOB=0, MTOCOMICOBD=0, TOTALPRD=0, TOTALSRV=0, Descto1=0
WHERE SAFACT.NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NROCTROL='ANULADO')

UPDATE SATAXVTA SET MONTO=0, MTOTAX=0, TGRAVABLE=0
WHERE SATAXVTA.NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NroCtrol='ANULADO')

UPDATE SATAXCXC SET MONTO=0, MTOTAX=0, TGRAVABLE=0 
WHERE SATAXCXC.NROPPAL=(SELECT NROUNICO FROM INSERTED WHERE NroCtrol='ANULADO')

END
IF (SELECT TIPOCXC FROM INSERTED)='10' 
BEGIN
update saacxc set monto=0, montoneto=0, mtotax=0, reteniva=0,saldo=0, saldoorg=0,
baseimpo=0
WHERE SAACXC.NroCtrol='ANULADO' AND SAACXC.NUMEROD=(SELECT NUMEROD FROM INSERTED)

UPDATE SAFACT SET DESCRIP='ANULADO', DIREC1='ANULADO', ID3='ANULADO', MONTO=0, MTOTAX=0,
TGRAVABLE=0, RETENIVA=0, MTOCOMIVTA=0, MTOCOMICOB=0, MTOCOMICOBD=0, TOTALPRD=0, TOTALSRV=0, Descto1=0
WHERE SAFACT.NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NROCTROL='ANULADO')

UPDATE SATAXVTA SET MONTO=0, MTOTAX=0, TGRAVABLE=0
WHERE SATAXVTA.NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NroCtrol='ANULADO')

UPDATE SAPROD 
SET EXISTEN=EXISTEN+ISNULL((SELECT CANTIDAD FROM SAITEMFAC WHERE SAPROD.CODPROD=SAITEMFAC.CODITEM AND NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NroCtrol='ANULADO')),0)

UPDATE SAEXIS 
SET EXISTEN=EXISTEN+ISNULL((SELECT CANTIDAD FROM SAITEMFAC WHERE SAEXIS.CODPROD=SAITEMFAC.CODITEM AND NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NroCtrol='ANULADO')),0)
END
IF (SELECT TIPOCXC FROM INSERTED)='41'  and (select nroctrol from inserted)='ANULADO'
BEGIN
update saacxc set saldo=monto
where saacxc.NUMEROD in(select NUMEROD from sapagcxc where nroppal=(select nrounico from inserted))
DELETE FROM SAPAGCXC
WHERE NROPPAL=(SELECT NROUNICO FROM INSERTED)
DELETE FROM SAACXC
WHERE NROUNICO=(SELECT NROUNICO FROM INSERTED)
END
IF (SELECT TIPOCXC FROM INSERTED)='81'  and (select nroctrol from inserted)='ANULADO'
BEGIN
update saacxc set saldo=SALDO+(SELECT monto FROM INSERTED)
where saacxc.NUMEROD = SUBSTRING((select NUMEROD from inserted),2,8)
DELETE FROM SAACXC
WHERE NROUNICO=(SELECT NROUNICO FROM INSERTED)
END
IF (SELECT TIPOCXC FROM INSERTED)='20' 
BEGIN
update saacxc set monto=0, montoneto=0, mtotax=0, reteniva=0,saldo=0, saldoorg=0,
baseimpo=0
WHERE SAACXC.NroCtrol='ANULADO' AND SAACXC.NUMEROD=(SELECT NUMEROD FROM INSERTED)
UPDATE SAFACT SET MONTO=0, MTOTAX=0,
TGRAVABLE=0, RETENIVA=0, MTOCOMIVTA=0, MTOCOMICOB=0, MTOCOMICOBD=0, TOTALPRD=0, TOTALSRV=0, Descto1=0
WHERE SAFACT.NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NROCTROL='ANULADO')

UPDATE SATAXVTA SET MONTO=0, MTOTAX=0, TGRAVABLE=0
WHERE SATAXVTA.NUMEROD=(SELECT NUMEROD FROM INSERTED WHERE NroCtrol='ANULADO')


END
END
END
